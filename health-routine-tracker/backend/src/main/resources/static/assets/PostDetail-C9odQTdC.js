import{l as C,i as N,b as w,t as S,d as b,c as A,e as I,r as c,j as e,B as r,f as L,g as T,h as R}from"./index-B9CrD5jL.js";import{a as E,b as H}from"./queries-CaU7-dRm.js";import{M}from"./Modal-DmSYBB7-.js";import{S as D}from"./Section-BUPE_Zxl.js";import{E as F}from"./State-BeJNxEGY.js";function p(){try{const t=localStorage.getItem("hrt:user");if(!t)return 1;const i=JSON.parse(t);return Number(i.id)||1}catch{return 1}}async function B(t){return localStorage.getItem("hrt:token")?(await w(Number(t),0,50)).content.map(s=>({id:String(s.id),routineId:String(s.routineId),nickname:`user-${s.userId}`,content:s.content,createdAt:s.createdAt})):[]}async function $(t,i,s){const l=p(),a=await I(Number(t),l,s);return{id:String(a.id),routineId:t,nickname:i||`user-${a.userId}`,content:a.content,createdAt:a.createdAt}}async function O(t){const i=p();await b(Number(t),i)}async function P(t,i){const s=p(),l=(i??"").trim();await A(Number(t),s,l)}async function z(t){const i=await C(Number(t));let s=!1;return localStorage.getItem("hrt:token")&&(s=await N(Number(t),p())),{routineId:t,likeCount:i,meLiked:s}}async function J(t){const i=await S(Number(t),p());return{routineId:t,likeCount:i.likeCount,meLiked:i.liked}}function U({id:t,nickname:i,createdAt:s,content:l,onDeleted:a,onUpdated:h}){const[x,d]=c.useState(!1),[m,j]=c.useState(l);return e.jsxs("div",{className:"row",children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:i}),e.jsx("div",{className:"muted",style:{fontSize:12},children:new Date(s).toLocaleString()}),x?e.jsx("textarea",{value:m,onChange:u=>j(u.target.value),style:{width:"100%",minHeight:80}}):e.jsx("div",{style:{marginTop:6},children:l})]}),e.jsx("div",{style:{display:"flex",gap:8},children:x?e.jsxs(e.Fragment,{children:[e.jsx(r,{variant:"ghost",onClick:()=>d(!1),children:"취소"}),e.jsx(r,{onClick:async()=>{await P(t,m),d(!1),h?h(t,m):location.reload()},children:"저장"})]}):e.jsxs(e.Fragment,{children:[e.jsx(r,{variant:"ghost",onClick:()=>d(!0),children:"수정"}),e.jsx(r,{variant:"danger",onClick:async()=>{await O(t),a?a(t):location.reload()},children:"삭제"})]})})]})}function V(){const{id:t}=L(),i=T(),{data:s}=E(t??""),l=H(),{push:a}=R(),[h,x]=c.useState({routineId:"",likeCount:0,meLiked:!1}),[d,m]=c.useState(""),[j,u]=c.useState([]),[y,f]=c.useState(!1);return c.useEffect(()=>{(async()=>{if(!t)return;x(await z(t));const n=await B(t);u(n)})()},[t]),e.jsxs(D,{children:[!s&&e.jsx(F,{message:"존재하지 않는 루틴입니다."}),s&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"modern-card container-narrow",style:{display:"grid",gap:16},children:[e.jsxs("div",{className:"section-head",children:[e.jsxs("h2",{children:[s.date," 루틴"]}),e.jsx("span",{className:"chip",children:s.exerciseType??"-"})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:16,alignItems:"stretch"},children:[e.jsxs("div",{className:"kpi",style:{borderTop:"4px solid var(--green-700)",minHeight:112},children:[e.jsx("div",{className:"kpi-title",children:"수면"}),e.jsxs("div",{className:"kpi-value",children:[s.sleepHours??"-"," h"]})]}),e.jsxs("div",{className:"kpi",style:{borderTop:"4px solid var(--green-500)",minHeight:112},children:[e.jsx("div",{className:"kpi-title",children:"운동"}),e.jsxs("div",{className:"kpi-value",children:[s.exerciseMinutes??0," 분"]})]}),e.jsxs("div",{className:"kpi",style:{borderTop:"4px solid var(--lime-300)",minHeight:112},children:[e.jsx("div",{className:"kpi-title",children:"물"}),e.jsxs("div",{className:"kpi-value",children:[s.waterMl??0," ml"]})]})]}),s.meals&&e.jsxs("div",{children:[e.jsx("strong",{children:"식사"}),e.jsx("div",{children:s.meals})]}),s.note&&e.jsxs("div",{children:[e.jsx("strong",{children:"메모"}),e.jsx("div",{children:s.note})]}),e.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center"},children:[e.jsx(r,{onClick:()=>i(`/posts/${t}/edit`),children:"수정"}),e.jsx(r,{variant:"danger",onClick:()=>f(!0),children:"삭제"}),e.jsxs(r,{variant:"ghost",onClick:async()=>{if(!localStorage.getItem("hrt:token")){alert("로그인이 필요합니다."),i("/login");return}if(t){const n=await J(t);x(n)}},children:[h.meLiked?"좋아요 취소":"좋아요"," (",h.likeCount,")"]})]})]}),e.jsxs("div",{className:"modern-card container-narrow",style:{display:"grid",gap:8},children:[e.jsx("h3",{children:"댓글"}),e.jsxs("div",{style:{display:"grid",gap:8},children:[j.map(n=>e.jsx(U,{id:n.id,nickname:n.nickname,createdAt:n.createdAt,content:n.content,onDeleted:o=>u(g=>g.filter(v=>v.id!==o)),onUpdated:(o,g)=>u(v=>v.map(k=>k.id===o?{...k,content:g}:k))},n.id)),e.jsxs("form",{onSubmit:async n=>{if(n.preventDefault(),!!t){if(!localStorage.getItem("hrt:token")){alert("로그인이 필요합니다."),i("/login");return}try{const o=await $(t,"게스트",d);u(g=>[...g,o]),m(""),a("댓글이 등록되었습니다.","success")}catch(o){a(o?.message??"ERROR","error")}}},style:{display:"flex",gap:8},children:[e.jsx("input",{value:d,onChange:n=>m(n.target.value),placeholder:"댓글을 입력하세요 (1~500자)",style:{flex:1,padding:"10px 12px",borderRadius:10,border:"1px solid var(--color-border)",background:"var(--color-surface)",color:"var(--color-fg)"}}),e.jsx(r,{type:"submit",children:"등록"})]})]})]}),e.jsx(M,{open:y,onClose:()=>f(!1),title:"삭제 확인",actions:e.jsxs(e.Fragment,{children:[e.jsx(r,{variant:"ghost",onClick:()=>f(!1),children:"취소"}),e.jsx(r,{variant:"danger",onClick:async()=>{t&&(await l.mutateAsync(t),a("삭제되었습니다.","success"),i("/posts"))},children:"삭제"})]}),children:"이 루틴을 삭제하시겠어요? 이 작업은 되돌릴 수 없습니다."})]})]})}export{V as default};
